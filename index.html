<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Pricing Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .icon {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            stroke-width: 2;
            stroke: currentColor;
            fill: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app" class="p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center gap-3 mb-2">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h1 class="text-3xl font-bold text-gray-900">Dynamic Pricing Calculator</h1>
                </div>
                <p class="text-gray-600">Intelligent discount recommendations based on deal factors and margin targets</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Input Panel -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Deal Information</h2>
                    
                    <div class="space-y-4">
                        <!-- Product Selection -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">Products</label>
                                <button id="addProductBtn" class="text-sm text-indigo-600 hover:text-indigo-700 font-medium">
                                    + Add Product
                                </button>
                            </div>
                            <div id="productsContainer" class="space-y-2"></div>
                        </div>

                        <!-- Deal Type -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deal Type</label>
                            <select id="dealType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="new">New Business</option>
                                <option value="renewal">Renewal</option>
                                <option value="expansion">Expansion</option>
                            </select>
                        </div>

                        <!-- Region -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Region</label>
                            <select id="region" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="north-america">North America</option>
                                <option value="emea">EMEA</option>
                                <option value="apac">APAC</option>
                                <option value="latam">LATAM</option>
                                <option value="emerging">Emerging Markets</option>
                            </select>
                        </div>

                        <!-- Payment Terms -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Payment Terms</label>
                            <select id="paymentTerms" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="annual">Annual (upfront)</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="monthly">Monthly</option>
                                <option value="multi-year">Multi-Year Upfront</option>
                            </select>
                        </div>

                        <!-- Contract Length -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contract Length (Years)</label>
                            <input type="number" id="contractLength" value="1" min="1" max="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <p id="contractLengthHint" class="text-xs text-gray-500 mt-1"></p>
                        </div>

                        <!-- Customer Risk -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Customer Credit Risk</label>
                            <select id="customerRisk" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="low">Low Risk</option>
                                <option value="medium">Medium Risk</option>
                                <option value="high">High Risk</option>
                            </select>
                        </div>

                        <!-- Competitive Pressure -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Competitive Pressure</label>
                            <select id="competitivePressure" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="low">Low Competition</option>
                                <option value="medium" selected>Medium Competition</option>
                                <option value="high">High Competition</option>
                            </select>
                        </div>

                        <!-- Partner Tier -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Partner Tier</label>
                            <select id="partnerTier" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="none">Direct (No Partner)</option>
                                <option value="tier-3">Tier 3 - Referral (10% base)</option>
                                <option value="tier-2">Tier 2 - Standard (20% base)</option>
                                <option value="tier-1">Tier 1 - Strategic (25% base + incumbency)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Results Panel -->
                <div id="resultsPanel" class="space-y-6"></div>
            </div>

            <!-- Footer Info -->
            <div class="mt-6 bg-indigo-50 rounded-lg shadow p-4">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-indigo-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                    </svg>
                    <div class="text-sm text-indigo-900">
                        <p class="font-semibold mb-1">Sales Leader Incentive</p>
                        <p class="text-indigo-700">
                            Maintain 60.0% average margin across all deals to maximize commission. 
                            Pre-approved discounts help you close faster while meeting margin targets.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Product catalog
        const products = [
            { id: 'sales-starter', name: 'Sales Hub - Starter', listPrice: 1200, margin: 0.85 },
            { id: 'sales-pro', name: 'Sales Hub - Professional', listPrice: 12000, margin: 0.82 },
            { id: 'sales-enterprise', name: 'Sales Hub - Enterprise', listPrice: 48000, margin: 0.78 },
            { id: 'marketing-starter', name: 'Marketing Hub - Starter', listPrice: 1800, margin: 0.83 },
            { id: 'marketing-pro', name: 'Marketing Hub - Professional', listPrice: 18000, margin: 0.80 },
            { id: 'marketing-enterprise', name: 'Marketing Hub - Enterprise', listPrice: 60000, margin: 0.75 },
            { id: 'service-pro', name: 'Service Hub - Professional', listPrice: 15000, margin: 0.81 },
            { id: 'bundle', name: 'Full Platform Bundle', listPrice: 100000, margin: 0.72 }
        ];

        // Partner program structure
        const partnerProgram = {
            'tier-1': { discount: 0.25, label: 'Tier 1 (Strategic)', grrBoost: 0.02, nrrBoost: 0.02, creditRiskReduction: 0.05 },
            'tier-2': { discount: 0.20, label: 'Tier 2', grrBoost: 0.02, nrrBoost: 0.02, creditRiskReduction: 0.05 },
            'tier-3': { discount: 0.10, label: 'Tier 3 (Referral)', grrBoost: 0.02, nrrBoost: 0.02, creditRiskReduction: 0.05 },
            'none': { discount: 0, label: 'Direct (No Partner)', grrBoost: 0, nrrBoost: 0, creditRiskReduction: 0 }
        };

        // Base retention assumptions
        const baseGRR = 0.90;
        const baseNRR = 1.10;
        const baseCreditRisk = 0.07;
        const marginTarget = 0.60;

        // State
        let dealData = {
            products: [{ id: 'sales-pro', quantity: 1 }],
            dealType: 'new',
            region: 'north-america',
            paymentTerms: 'annual',
            contractLength: 1,
            customerRisk: 'low',
            competitivePressure: 'medium',
            partnerTier: 'none'
        };

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatPercent(decimal) {
            return (decimal * 100).toFixed(1) + '%';
        }

        // Render products
        function renderProducts() {
            const container = document.getElementById('productsContainer');
            container.innerHTML = dealData.products.map((item, index) => {
                const product = products.find(p => p.id === item.id);
                return `
                    <div class="flex gap-2 items-center bg-gray-50 p-3 rounded-lg">
                        <select data-index="${index}" class="product-select flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
                            ${products.map(p => `<option value="${p.id}" ${p.id === item.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                        <input type="number" data-index="${index}" value="${item.quantity}" min="1" 
                            class="quantity-input w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm" 
                            placeholder="Qty">
                        <div class="text-sm font-semibold text-gray-700 w-24 text-right">
                            ${formatCurrency(product.listPrice * item.quantity)}
                        </div>
                        ${dealData.products.length > 1 ? `
                            <button data-index="${index}" class="remove-product text-red-600 hover:text-red-700 text-sm font-medium">
                                âœ•
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');

            // Add event listeners
            document.querySelectorAll('.product-select').forEach(el => {
                el.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    dealData.products[index].id = e.target.value;
                    calculate();
                });
            });

            document.querySelectorAll('.quantity-input').forEach(el => {
                el.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    dealData.products[index].quantity = parseInt(e.target.value) || 1;
                    calculate();
                });
            });

            document.querySelectorAll('.remove-product').forEach(el => {
                el.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    dealData.products.splice(index, 1);
                    calculate();
                });
            });
        }

        // Calculate discount
        function calculateDiscount() {
            let totalListPrice = 0;
            let weightedMargin = 0;
            
            dealData.products.forEach(item => {
                const product = products.find(p => p.id === item.id);
                const itemValue = product.listPrice * item.quantity;
                totalListPrice += itemValue;
                weightedMargin += product.margin * itemValue;
            });
            
            weightedMargin = weightedMargin / totalListPrice;
            const isMultiProduct = dealData.products.length > 1;
            
            const partner = partnerProgram[dealData.partnerTier];
            
            let baseDiscount = 0;
            let maxDiscount = 0;

            if (dealData.partnerTier !== 'none') {
                baseDiscount = partner.discount;
                maxDiscount = partner.discount + 0.10;
                
                if (dealData.partnerTier === 'tier-1') {
                    maxDiscount = partner.discount + 0.12;
                }
            } else {
                if (totalListPrice >= 50000) {
                    baseDiscount = 0.15;
                    maxDiscount = 0.25;
                } else if (totalListPrice >= 20000) {
                    baseDiscount = 0.10;
                    maxDiscount = 0.20;
                } else if (totalListPrice >= 10000) {
                    baseDiscount = 0.05;
                    maxDiscount = 0.15;
                } else {
                    baseDiscount = 0.02;
                    maxDiscount = 0.10;
                }
            }

            let adjustments = [];
            
            if (isMultiProduct) {
                adjustments.push({ factor: 'Multi-Product Bundle', impact: 0.05 });
            }
            
            if (dealData.dealType === 'renewal') {
                adjustments.push({ factor: 'Renewal Customer', impact: -0.03 });
                if (dealData.partnerTier === 'tier-1') {
                    adjustments.push({ factor: 'Tier 1 Incumbency Rights', impact: 0.05 });
                }
            } else if (dealData.dealType === 'expansion') {
                adjustments.push({ factor: 'Expansion Deal', impact: -0.05 });
            } else {
                adjustments.push({ factor: 'New Customer', impact: 0.02 });
            }

            if (dealData.contractLength >= 3) {
                adjustments.push({ factor: '3+ Year Contract', impact: 0.08 });
            } else if (dealData.contractLength === 2) {
                adjustments.push({ factor: '2 Year Contract', impact: 0.05 });
            }

            if (dealData.paymentTerms === 'multi-year') {
                adjustments.push({ factor: 'Multi-Year Upfront Payment', impact: 0.03 });
            } else if (dealData.paymentTerms === 'quarterly') {
                adjustments.push({ factor: 'Quarterly Payment', impact: -0.02 });
            } else if (dealData.paymentTerms === 'monthly') {
                adjustments.push({ factor: 'Monthly Payment', impact: -0.03 });
            }

            if (dealData.customerRisk === 'high' && dealData.partnerTier === 'none') {
                adjustments.push({ factor: 'High Credit Risk', impact: -0.05 });
            } else if (dealData.customerRisk === 'low') {
                adjustments.push({ factor: 'Low Credit Risk', impact: 0.02 });
            }

            if (dealData.competitivePressure === 'high') {
                adjustments.push({ factor: 'High Competition', impact: 0.03 });
            } else if (dealData.competitivePressure === 'low') {
                adjustments.push({ factor: 'Low Competition', impact: -0.02 });
            }

            if (dealData.region === 'emerging') {
                adjustments.push({ factor: 'Emerging Market', impact: 0.03 });
            } else if (dealData.region === 'apac') {
                adjustments.push({ factor: 'APAC Region', impact: 0.02 });
            }

            if (dealData.partnerTier !== 'none') {
                adjustments.push({ factor: `${partner.label} Base`, impact: partner.discount, isBase: true });
            }

            const incrementalAdjustments = adjustments.filter(a => !a.isBase);
            const totalAdjustment = incrementalAdjustments.reduce((sum, adj) => sum + adj.impact, 0);
            let recommendedDiscount = Math.min(baseDiscount + totalAdjustment, maxDiscount);
            recommendedDiscount = Math.max(0, recommendedDiscount);

            const discountAmount = totalListPrice * recommendedDiscount;
            const finalPrice = totalListPrice - discountAmount;
            const cost = totalListPrice * (1 - weightedMargin);
            const profit = finalPrice - cost;
            const dealMargin = profit / finalPrice;
            
            const effectiveGRR = baseGRR + partner.grrBoost;
            const effectiveNRR = baseNRR + partner.nrrBoost;
            const effectiveCreditRisk = baseCreditRisk - partner.creditRiskReduction;
            
            const year1Value = profit;
            const year2Value = dealData.dealType === 'new' 
                ? finalPrice * effectiveGRR * effectiveNRR * dealMargin * (1 - effectiveCreditRisk)
                : finalPrice * effectiveNRR * dealMargin * (1 - effectiveCreditRisk);
            const year3Value = dealData.dealType === 'new'
                ? finalPrice * effectiveGRR * Math.pow(effectiveNRR, 2) * dealMargin * (1 - effectiveCreditRisk)
                : finalPrice * Math.pow(effectiveNRR, 2) * dealMargin * (1 - effectiveCreditRisk);
            
            const totalLTV = year1Value + year2Value + year3Value;
            const effectiveMargin = totalLTV / (finalPrice * 3);
            
            let status = 'approved';
            let statusMessage = 'Pre-approved - No escalation needed';
            
            const marginToCheck = dealData.partnerTier !== 'none' ? effectiveMargin : dealMargin;
            
            if (marginToCheck < marginTarget) {
                status = 'warning';
                statusMessage = dealData.partnerTier !== 'none' 
                    ? 'Below margin target even with partner benefits - Sales leader review recommended'
                    : 'Below margin target - Sales leader review recommended';
            }
            
            if (recommendedDiscount > maxDiscount * 0.95) {
                status = 'escalation';
                statusMessage = 'Near discount limit - Finance approval required';
            }
            
            if (dealData.partnerTier !== 'none' && recommendedDiscount <= partner.discount + 0.05) {
                status = 'approved';
                statusMessage = `Pre-approved ${partner.label} deal - Partner benefits justify discount`;
            }

            return {
                recommendedDiscount,
                maxDiscount,
                discountAmount,
                finalPrice,
                totalListPrice,
                cost,
                profit,
                dealMargin,
                effectiveMargin,
                effectiveGRR,
                effectiveNRR,
                effectiveCreditRisk,
                totalLTV,
                year1Value,
                year2Value,
                year3Value,
                adjustments,
                status,
                statusMessage,
                isPartnerDeal: dealData.partnerTier !== 'none',
                isMultiProduct
            };
        }

        // Render results
        function renderResults(rec) {
            const statusColors = {
                approved: { bg: 'bg-green-50 border-green-200', icon: 'text-green-600', text: 'text-green-900', subtext: 'text-green-700' },
                warning: { bg: 'bg-yellow-50 border-yellow-200', icon: 'text-yellow-600', text: 'text-yellow-900', subtext: 'text-yellow-700' },
                escalation: { bg: 'bg-red-50 border-red-200', icon: 'text-red-600', text: 'text-red-900', subtext: 'text-red-700' }
            };
            
            const colors = statusColors[rec.status];
            const statusTitle = rec.status === 'approved' ? 'Pre-Approved' : rec.status === 'warning' ? 'Review Required' : 'Escalation Required';
            
            const discountBarColor = rec.recommendedDiscount / rec.maxDiscount > 0.9 ? 'bg-red-500' :
                                    rec.recommendedDiscount / rec.maxDiscount > 0.7 ? 'bg-yellow-500' : 'bg-green-500';
            
            const marginToCheck = rec.isPartnerDeal ? rec.effectiveMargin : rec.dealMargin;
            const marginBarColor = marginToCheck >= marginTarget ? 'bg-green-500' : 'bg-red-500';
            
            let html = `
                <!-- Status Card -->
                <div class="${colors.bg} border-2 rounded-lg shadow-lg p-6">
                    <div class="flex items-start gap-3">
                        <svg class="w-6 h-6 ${colors.icon} flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${rec.status === 'approved' ? 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' : 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z'}"></path>
                        </svg>
                        <div>
                            <h3 class="font-bold text-lg ${colors.text}">${statusTitle}</h3>
                            <p class="text-sm mt-1 ${colors.subtext}">${rec.statusMessage}</p>
                        </div>
                    </div>
                </div>

                <!-- Pricing Summary -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Recommended Discount</h3>
                    
                    ${rec.isMultiProduct ? `
                    <div class="mb-4 pb-4 border-b">
                        <div class="flex items-center gap-2 text-sm text-indigo-600 font-semibold mb-2">
                            <span>ðŸ“¦</span>
                            <span>Multi-Product Bundle</span>
                        </div>
                        <div class="text-xs text-gray-600">
                            ${dealData.products.length} products â€¢ 5% bundle discount applied
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center pb-3 border-b">
                            <span class="text-gray-600">Total List Price:</span>
                            <span class="font-semibold text-lg">${formatCurrency(rec.totalListPrice)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center pb-3 border-b">
                            <span class="text-gray-600">Recommended Discount:</span>
                            <span class="font-bold text-xl text-indigo-600">${formatPercent(rec.recommendedDiscount)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center pb-3 border-b">
                            <span class="text-gray-600">Discount Amount:</span>
                            <span class="font-semibold text-red-600">-${formatCurrency(rec.discountAmount)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center pt-2">
                            <span class="text-gray-900 font-semibold">Final Price:</span>
                            <span class="font-bold text-2xl text-green-600">${formatCurrency(rec.finalPrice)}</span>
                        </div>
                        
                        ${dealData.contractLength > 1 ? `
                        <div class="bg-blue-50 p-3 rounded-lg mt-3">
                            <div class="text-sm text-blue-900">
                                <div class="font-semibold">${dealData.contractLength}-Year Total Contract Value:</div>
                                <div class="text-2xl font-bold text-blue-600 mt-1">
                                    ${formatCurrency(rec.finalPrice * dealData.contractLength)}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>

                    <div class="mt-6 pt-4 border-t">
                        <div class="flex justify-between items-center text-sm text-gray-600 mb-2">
                            <span>Discount Usage</span>
                            <span>${formatPercent(rec.recommendedDiscount / rec.maxDiscount)} of max</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${discountBarColor} h-2 rounded-full transition-all" style="width: ${(rec.recommendedDiscount / rec.maxDiscount) * 100}%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Maximum allowed: ${formatPercent(rec.maxDiscount)}</p>
                    </div>
                </div>

                <!-- Margin Analysis -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                        <h3 class="text-lg font-bold text-gray-900">Margin Analysis</h3>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center pb-3 border-b">
                            <span class="text-gray-600">Deal Margin (Year 1):</span>
                            <span class="font-semibold">${formatPercent(rec.dealMargin)}</span>
                        </div>
                        
                        ${rec.isPartnerDeal ? `
                        <div class="bg-blue-50 p-3 rounded-lg space-y-2">
                            <div class="text-sm font-semibold text-blue-900">Partner Benefits:</div>
                            <div class="text-xs text-blue-800 space-y-1">
                                <div class="flex justify-between">
                                    <span>GRR Improvement:</span>
                                    <span>${formatPercent(rec.effectiveGRR - baseGRR)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>NRR Improvement:</span>
                                    <span>${formatPercent(rec.effectiveNRR - baseNRR)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Credit Risk Reduction:</span>
                                    <span>${formatPercent(baseCreditRisk - rec.effectiveCreditRisk)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center pt-2">
                            <span class="text-gray-900 font-semibold">Effective Margin (3-yr):</span>
                            <span class="font-bold text-lg ${rec.effectiveMargin >= marginTarget ? 'text-green-600' : 'text-yellow-600'}">
                                ${formatPercent(rec.effectiveMargin)}
                            </span>
                        </div>
                        ` : `
                        <div class="flex justify-between items-center pt-2">
                            <span class="text-gray-900 font-semibold">Actual Margin:</span>
                            <span class="font-bold text-lg ${rec.dealMargin >= marginTarget ? 'text-green-600' : 'text-red-600'}">
                                ${formatPercent(rec.dealMargin)}
                            </span>
                        </div>
                        `}
                        
                        <div class="flex justify-between items-center text-sm border-t pt-3">
                            <span class="text-gray-600">Target Margin:</span>
                            <span class="font-semibold">${formatPercent(marginTarget)}</span>
                        </div>
                    </div>

                    <div class="mt-4">
                        <div class="flex justify-between items-center text-sm text-gray-600 mb-2">
                            <span>Margin Performance</span>
                            <span>${marginToCheck >= marginTarget ? 'On Target' : 'Below Target'}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${marginBarColor} h-2 rounded-full transition-all" style="width: ${Math.min((marginToCheck / marginTarget) * 100, 100)}%"></div>
                        </div>
                    </div>
                </div>

                ${rec.isPartnerDeal ? `
                <!-- LTV Breakdown -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Account LTV (3-Year)</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center pb-2 border-b">
                            <span class="text-gray-600">Year 1 Profit:</span>
                            <span class="font-semibold">${formatCurrency(rec.year1Value)}</span>
                        </div>
                        <div class="flex justify-between items-center pb-2 border-b">
                            <span class="text-gray-600">Year 2 Profit:</span>
                            <span class="font-semibold">${formatCurrency(rec.year2Value)}</span>
                        </div>
                        <div class="flex justify-between items-center pb-2 border-b">
                            <span class="text-gray-600">Year 3 Profit:</span>
                            <span class="font-semibold">${formatCurrency(rec.year3Value)}</span>
                        </div>
                        <div class="flex justify-between items-center pt-2 bg-green-50 p-3 rounded-lg">
                            <span class="text-gray-900 font-bold">Total LTV:</span>
                            <span class="font-bold text-xl text-green-600">${formatCurrency(rec.totalLTV)}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">
                            Accounts for ${formatPercent(rec.effectiveGRR)} GRR, 
                            ${formatPercent(rec.effectiveNRR)} NRR, 
                            and ${formatPercent(rec.effectiveCreditRisk)} credit risk
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Discount Factors -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Discount Factors</h3>
                    <div class="space-y-2">
                        ${rec.adjustments.map(adj => `
                            <div class="flex justify-between items-center text-sm py-2 border-b border-gray-100">
                                <span class="text-gray-700">${adj.factor}</span>
                                <span class="font-semibold ${adj.impact > 0 ? 'text-red-600' : 'text-green-600'}">
                                    ${adj.impact > 0 ? '+' : ''}${formatPercent(adj.impact)}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('resultsPanel').innerHTML = html;
        }

        // Update contract length hint
        function updateContractLengthHint() {
            const hint = document.getElementById('contractLengthHint');
            const length = dealData.contractLength;
            if (length >= 3) {
                hint.textContent = 'ðŸŽ¯ 3+ year deals get 8% extra discount';
            } else if (length === 2) {
                hint.textContent = 'ðŸŽ¯ 2 year deals get 5% extra discount';
            } else {
                hint.textContent = 'Tip: Multi-year contracts unlock higher discounts';
            }
        }

        // Main calculation and render function
        function calculate() {
            renderProducts();
            updateContractLengthHint();
            const recommendation = calculateDiscount();
            renderResults(recommendation);
        }

        // Event listeners
        document.getElementById('addProductBtn').addEventListener('click', () => {
            dealData.products.push({ id: 'sales-starter', quantity: 1 });
            calculate();
        });

        ['dealType', 'region', 'paymentTerms', 'customerRisk', 'competitivePressure', 'partnerTier'].forEach(id => {
            document.getElementById(id).addEventListener('change', (e) => {
                dealData[id] = e.target.value;
                calculate();
            });
        });

        document.getElementById('contractLength').addEventListener('input', (e) => {
            dealData.contractLength = parseInt(e.target.value) || 1;
            calculate();
        });

        // Initial render
        calculate();
    </script>
</body>
</html>
